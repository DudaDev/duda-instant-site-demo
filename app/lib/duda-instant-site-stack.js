"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DudaInstantSiteStack = void 0;
const cdk = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const s3 = require("@aws-cdk/aws-s3");
const cf = require("@aws-cdk/aws-cloudfront");
const apiGateway = require("@aws-cdk/aws-apigateway");
const dotenv = require("dotenv");
const aws_apigateway_1 = require("@aws-cdk/aws-apigateway");
const routes_1 = require("./routes");
const pjson = require("../package.json");
const aws_cognito_1 = require("@aws-cdk/aws-cognito");
dotenv.config();
const verbs = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'];
const environment = (({ API_USER = '', API_PASS = '', API_BASE = '', WEBUI_USER = '', WEBUI_TEMP_PASS = '', REGION = '' }) => ({
    API_USER,
    API_PASS,
    API_BASE,
    WEBUI_USER,
    WEBUI_TEMP_PASS,
    REGION,
    VERSION: pjson.version,
    NODE_PATH: '/opt/nodejs/lib/:/opt/nodejs/node_modules:$LAMBDA_RUNTIME_DIR/node_modules'
}))(process.env);
class DudaInstantSiteStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.layer = this.createLayer();
        // S3 frontend bucket
        this.s3bucket = new s3.Bucket(this, "DudaInstantSiteFrontend", {
            publicReadAccess: true,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            websiteIndexDocument: "index.html"
        });
        // Cloudfront
        this.cloudfront = new cf.CloudFrontWebDistribution(this, "CDKCRAStaticDistribution", {
            originConfigs: [
                {
                    s3OriginSource: {
                        s3BucketSource: this.s3bucket
                    },
                    behaviors: [{ isDefaultBehavior: true }]
                },
            ]
        });
        const userPool = new aws_cognito_1.UserPool(this, 'Instant Sites User Pool', {
            signInAliases: {
                username: true
            },
            selfSignUpEnabled: false
        });
        const userPoolClient = userPool.addClient('Instant Sites User Pool Client', {
            authFlows: {
                userSrp: true
            },
            oAuth: {
                callbackUrls: ['http://localhost:3000'],
                logoutUrls: ['http://localhost:3000'],
                flows: {
                    implicitCodeGrant: true
                }
            }
        });
        this.api = this.createAPI(routes_1.default);
        this.authorizer = new aws_apigateway_1.CfnAuthorizer(this, 'cfnAuth', {
            restApiId: this.api.restApiId,
            name: 'InstantSiteAPIAuthorizer',
            type: 'COGNITO_USER_POOLS',
            identitySource: 'method.request.header.Authorization',
            providerArns: [userPool.userPoolArn],
        });
        this.createResources(this.api.root, routes_1.default);
        new cdk.CfnOutput(this, "apiBase", {
            value: this.api.url
        });
        new cdk.CfnOutput(this, "userPoolId", {
            value: userPool.userPoolId
        });
        new cdk.CfnOutput(this, "userPoolClientId", {
            value: userPoolClient.userPoolClientId
        });
        new cdk.CfnOutput(this, "userPoolRegion", {
            value: environment.REGION
        });
        new cdk.CfnOutput(this, "s3Bucket", {
            value: this.s3bucket.bucketName
        });
        new cdk.CfnOutput(this, "cfDistributionDomainName", {
            value: this.cloudfront.distributionDomainName
        });
        new cdk.CfnOutput(this, "cfDistributionId", {
            value: this.cloudfront.distributionId
        });
        new cdk.CfnOutput(this, "webUiUser", {
            value: environment.WEBUI_USER
        });
        new cdk.CfnOutput(this, "webUiPass", {
            value: environment.WEBUI_TEMP_PASS
        });
    }
    createResources(resource, obj) {
        for (const [key, value] of Object.entries(obj)) {
            verbs.includes(key.toUpperCase())
                ? resource.addMethod(key, new apiGateway.LambdaIntegration(this.createLambda(key.toUpperCase(), value)), {
                    authorizationType: aws_apigateway_1.AuthorizationType.COGNITO,
                    authorizer: {
                        authorizerId: this.authorizer.ref
                    }
                })
                : this.createResources(resource.addResource(key), value);
        }
        return resource;
    }
    createAPI(routes) {
        const api = new apiGateway.LambdaRestApi(this, 'duda', {
            handler: this.createLambda('ANY', 'root'),
            proxy: false,
            defaultCorsPreflightOptions: this.getCORS(this.cloudfront.distributionDomainName)
        });
        api.root.addMethod('ANY');
        return api;
    }
    getCORS(domain) {
        return {
            allowOrigins: ["*"],
            allowMethods: ["OPTIONS", "GET", "PUT", "POST", "DELETE", "PATCH"],
            allowHeaders: ["Content-Type",
                "X-Amz-Date",
                "Authorization",
                "X-Api-Key",
                "X-Amz-Security-Token",
                "X-Amz-User-Agent"],
            allowCredentials: false
        };
    }
    createLambda(verb, dir) {
        return new lambda.Function(this, `${verb}-${dir}-Lambda`, this.getLambdaConfig(`lambdas/${dir}`));
    }
    getLambdaConfig(path) {
        return {
            code: lambda.Code.fromAsset(path),
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
            timeout: cdk.Duration.seconds(20),
            environment,
            layers: [this.layer]
        };
    }
    createLayer() {
        return new lambda.LayerVersion(this, 'lambda-layer', {
            code: lambda.Code.fromAsset('layers'),
            compatibleRuntimes: [lambda.Runtime.NODEJS_14_X],
        });
    }
}
exports.DudaInstantSiteStack = DudaInstantSiteStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVkYS1pbnN0YW50LXNpdGUtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkdWRhLWluc3RhbnQtc2l0ZS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBcUM7QUFDckMsOENBQThDO0FBQzlDLHNDQUFzQztBQUN0Qyw4Q0FBOEM7QUFDOUMsc0RBQXNEO0FBQ3RELGlDQUFpQztBQUVqQyw0REFBa0g7QUFDbEgscUNBQThCO0FBQzlCLHlDQUF5QztBQUN6QyxzREFBZ0Q7QUFFaEQsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRWhCLE1BQU0sS0FBSyxHQUFHLENBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUMsT0FBTyxFQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BELE1BQU0sV0FBVyxHQUFHLENBQ2xCLENBQUMsRUFBRSxRQUFRLEdBQUcsRUFBRSxFQUFFLFFBQVEsR0FBRyxFQUFFLEVBQUUsUUFBUSxHQUFHLEVBQUUsRUFBRSxVQUFVLEdBQUcsRUFBRSxFQUFFLFVBQVUsR0FBRyxFQUFFLEVBQUUsTUFBTSxHQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLFFBQVE7SUFDUixRQUFRO0lBQ1IsUUFBUTtJQUNSLFVBQVU7SUFDVixVQUFVO0lBQ1YsTUFBTTtJQUNOLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztJQUN0QixTQUFTLEVBQUUsNEVBQTRFO0NBQzFGLENBQUMsQ0FDSCxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUVmLE1BQWEsb0JBQXFCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFRakQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVoQyxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLHlCQUF5QixFQUFFO1lBQzdELGdCQUFnQixFQUFFLElBQUk7WUFDdEIsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTztZQUN4QyxvQkFBb0IsRUFBRSxZQUFZO1NBQ25DLENBQUMsQ0FBQztRQUVILGFBQWE7UUFDYixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksRUFBRSxDQUFDLHlCQUF5QixDQUFDLElBQUksRUFBRSwwQkFBMEIsRUFBRTtZQUNuRixhQUFhLEVBQUU7Z0JBQ2I7b0JBQ0UsY0FBYyxFQUFFO3dCQUNkLGNBQWMsRUFBRSxJQUFJLENBQUMsUUFBUTtxQkFDOUI7b0JBQ0QsU0FBUyxFQUFFLENBQUMsRUFBQyxpQkFBaUIsRUFBRSxJQUFJLEVBQUMsQ0FBQztpQkFDdkM7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sUUFBUSxHQUFHLElBQUksc0JBQVEsQ0FBQyxJQUFJLEVBQUUseUJBQXlCLEVBQUU7WUFDN0QsYUFBYSxFQUFFO2dCQUNiLFFBQVEsRUFBRSxJQUFJO2FBQ2Y7WUFDRCxpQkFBaUIsRUFBRSxLQUFLO1NBQ3pCLENBQUMsQ0FBQztRQUVILE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsZ0NBQWdDLEVBQUU7WUFDMUUsU0FBUyxFQUFFO2dCQUNULE9BQU8sRUFBRSxJQUFJO2FBQ2Q7WUFDRCxLQUFLLEVBQUU7Z0JBQ0wsWUFBWSxFQUFFLENBQUMsdUJBQXVCLENBQUM7Z0JBQ3ZDLFVBQVUsRUFBRSxDQUFDLHVCQUF1QixDQUFDO2dCQUNyQyxLQUFLLEVBQUU7b0JBQ0wsaUJBQWlCLEVBQUUsSUFBSTtpQkFDeEI7YUFDRjtTQUNGLENBQUMsQ0FBQTtRQUdGLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBTSxDQUFDLENBQUM7UUFFbEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLDhCQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtZQUNuRCxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTO1lBQzdCLElBQUksRUFBRSwwQkFBMEI7WUFDaEMsSUFBSSxFQUFFLG9CQUFvQjtZQUMxQixjQUFjLEVBQUUscUNBQXFDO1lBQ3JELFlBQVksRUFBRSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7U0FDckMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxnQkFBTSxDQUFDLENBQUM7UUFFNUMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUU7WUFDakMsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRztTQUNwQixDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRTtZQUNwQyxLQUFLLEVBQUUsUUFBUSxDQUFDLFVBQVU7U0FDM0IsQ0FBQyxDQUFBO1FBRUYsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUMxQyxLQUFLLEVBQUUsY0FBYyxDQUFDLGdCQUFnQjtTQUN2QyxDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQ3hDLEtBQUssRUFBRSxXQUFXLENBQUMsTUFBTTtTQUMxQixDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUNsQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVO1NBQ2hDLENBQUMsQ0FBQztRQUVILElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsMEJBQTBCLEVBQUU7WUFDbEQsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsc0JBQXNCO1NBQzlDLENBQUMsQ0FBQztRQUVILElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLEVBQUU7WUFDMUMsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYztTQUN0QyxDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRTtZQUNuQyxLQUFLLEVBQUUsV0FBVyxDQUFDLFVBQVU7U0FDOUIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUU7WUFDbkMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxVQUFVO1NBQzlCLENBQUMsQ0FBQztJQUVMLENBQUM7SUFFTyxlQUFlLENBQUMsUUFBbUIsRUFBRSxHQUFXO1FBQ3RELEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzlDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUM3QixDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQ3BCLElBQUksVUFBVSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxFQUFDLEtBQUssQ0FBQyxDQUFDLEVBQzVFO29CQUNFLGlCQUFpQixFQUFFLGtDQUFpQixDQUFDLE9BQU87b0JBQzVDLFVBQVUsRUFBRTt3QkFDVixZQUFZLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO3FCQUNsQztpQkFDRixDQUNGO2dCQUNILENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDOUQ7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRU8sU0FBUyxDQUFDLE1BQWM7UUFDOUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUU7WUFDckQsT0FBTyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFDLE1BQU0sQ0FBQztZQUN4QyxLQUFLLEVBQUUsS0FBSztZQUNaLDJCQUEyQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQztTQUNsRixDQUFDLENBQUM7UUFHSCxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFTyxPQUFPLENBQUMsTUFBYztRQUM1QixPQUFPO1lBQ0wsWUFBWSxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ25CLFlBQVksRUFBRSxDQUFDLFNBQVMsRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxRQUFRLEVBQUMsT0FBTyxDQUFDO1lBQzdELFlBQVksRUFBRSxDQUFDLGNBQWM7Z0JBQ2QsWUFBWTtnQkFDWixlQUFlO2dCQUNmLFdBQVc7Z0JBQ1gsc0JBQXNCO2dCQUN0QixrQkFBa0IsQ0FBQztZQUNsQyxnQkFBZ0IsRUFBRSxLQUFLO1NBQ3hCLENBQUE7SUFDSCxDQUFDO0lBRU8sWUFBWSxDQUFDLElBQVksRUFBRSxHQUFXO1FBQzVDLE9BQU8sSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksSUFBSSxHQUFHLFNBQVMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3BHLENBQUM7SUFFTyxlQUFlLENBQUMsSUFBWTtRQUNsQyxPQUFPO1lBQ0wsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztZQUNqQyxPQUFPLEVBQUUsZUFBZTtZQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1lBQ25DLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsV0FBVztZQUNYLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7U0FDckIsQ0FBQTtJQUNILENBQUM7SUFFTyxXQUFXO1FBQ2pCLE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDbkQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUNyQyxrQkFBa0IsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO1NBQy9DLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDRjtBQXhLRCxvREF3S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnQGF3cy1jZGsvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICdAYXdzLWNkay9hd3MtczMnO1xuaW1wb3J0ICogYXMgY2YgZnJvbSAnQGF3cy1jZGsvYXdzLWNsb3VkZnJvbnQnO1xuaW1wb3J0ICogYXMgYXBpR2F0ZXdheSBmcm9tICdAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheSc7XG5pbXBvcnQgKiBhcyBkb3RlbnYgZnJvbSAnZG90ZW52JztcbmltcG9ydCB7IEZ1bmN0aW9uLCBGdW5jdGlvblByb3BzLCBMYXllclZlcnNpb24gfSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCB7IENvcnNPcHRpb25zLCBJUmVzb3VyY2UsIExhbWJkYVJlc3RBcGksIENmbkF1dGhvcml6ZXIsIEF1dGhvcml6YXRpb25UeXBlIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXknO1xuaW1wb3J0IHJvdXRlcyBmcm9tICcuL3JvdXRlcyc7XG5pbXBvcnQgKiBhcyBwanNvbiBmcm9tICcuLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHsgVXNlclBvb2wgfSBmcm9tICdAYXdzLWNkay9hd3MtY29nbml0byc7XG5cbmRvdGVudi5jb25maWcoKTtcblxuY29uc3QgdmVyYnMgPSBbJ0dFVCcsJ1BPU1QnLCdQVVQnLCdQQVRDSCcsJ0RFTEVURSddO1xuY29uc3QgZW52aXJvbm1lbnQgPSAoXG4gICh7IEFQSV9VU0VSID0gJycsIEFQSV9QQVNTID0gJycsIEFQSV9CQVNFID0gJycsIFdFQlVJX1VTRVIgPSAnJywgV0VCVUlfUEFTUyA9ICcnLCBSRUdJT049JycgfSkgPT4gKHtcbiAgICAgIEFQSV9VU0VSLFxuICAgICAgQVBJX1BBU1MsXG4gICAgICBBUElfQkFTRSxcbiAgICAgIFdFQlVJX1VTRVIsXG4gICAgICBXRUJVSV9QQVNTLFxuICAgICAgUkVHSU9OLFxuICAgICAgVkVSU0lPTjogcGpzb24udmVyc2lvbixcbiAgICAgIE5PREVfUEFUSDogJy9vcHQvbm9kZWpzL2xpYi86L29wdC9ub2RlanMvbm9kZV9tb2R1bGVzOiRMQU1CREFfUlVOVElNRV9ESVIvbm9kZV9tb2R1bGVzJ1xuICB9KVxuKShwcm9jZXNzLmVudik7XG5cbmV4cG9ydCBjbGFzcyBEdWRhSW5zdGFudFNpdGVTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG5cbiAgcHJpdmF0ZSBsYXllcjogTGF5ZXJWZXJzaW9uO1xuICBwcml2YXRlIHMzYnVja2V0OiBzMy5CdWNrZXQ7XG4gIHByaXZhdGUgY2xvdWRmcm9udDogY2YuQ2xvdWRGcm9udFdlYkRpc3RyaWJ1dGlvbjtcbiAgcHJpdmF0ZSBhcGk6IExhbWJkYVJlc3RBcGk7XG4gIHByaXZhdGUgYXV0aG9yaXplcjogQ2ZuQXV0aG9yaXplcjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBjZGsuU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5sYXllciA9IHRoaXMuY3JlYXRlTGF5ZXIoKTtcblxuICAgIC8vIFMzIGZyb250ZW5kIGJ1Y2tldFxuICAgIHRoaXMuczNidWNrZXQgPSBuZXcgczMuQnVja2V0KHRoaXMsIFwiRHVkYUluc3RhbnRTaXRlRnJvbnRlbmRcIiwge1xuICAgICAgcHVibGljUmVhZEFjY2VzczogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICB3ZWJzaXRlSW5kZXhEb2N1bWVudDogXCJpbmRleC5odG1sXCJcbiAgICB9KTtcblxuICAgIC8vIENsb3VkZnJvbnRcbiAgICB0aGlzLmNsb3VkZnJvbnQgPSBuZXcgY2YuQ2xvdWRGcm9udFdlYkRpc3RyaWJ1dGlvbih0aGlzLCBcIkNES0NSQVN0YXRpY0Rpc3RyaWJ1dGlvblwiLCB7XG4gICAgICBvcmlnaW5Db25maWdzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBzM09yaWdpblNvdXJjZToge1xuICAgICAgICAgICAgczNCdWNrZXRTb3VyY2U6IHRoaXMuczNidWNrZXRcbiAgICAgICAgICB9LFxuICAgICAgICAgIGJlaGF2aW9yczogW3tpc0RlZmF1bHRCZWhhdmlvcjogdHJ1ZX1dXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyUG9vbCA9IG5ldyBVc2VyUG9vbCh0aGlzLCAnSW5zdGFudCBTaXRlcyBVc2VyIFBvb2wnLCB7XG4gICAgICBzaWduSW5BbGlhc2VzOiB7XG4gICAgICAgIHVzZXJuYW1lOiB0cnVlXG4gICAgICB9LFxuICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IGZhbHNlXG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyUG9vbENsaWVudCA9IHVzZXJQb29sLmFkZENsaWVudCgnSW5zdGFudCBTaXRlcyBVc2VyIFBvb2wgQ2xpZW50Jywge1xuICAgICAgYXV0aEZsb3dzOiB7XG4gICAgICAgIHVzZXJTcnA6IHRydWVcbiAgICAgIH0sXG4gICAgICBvQXV0aDoge1xuICAgICAgICBjYWxsYmFja1VybHM6IFsnaHR0cDovL2xvY2FsaG9zdDozMDAwJ10sXG4gICAgICAgIGxvZ291dFVybHM6IFsnaHR0cDovL2xvY2FsaG9zdDozMDAwJ10sXG4gICAgICAgIGZsb3dzOiB7XG4gICAgICAgICAgaW1wbGljaXRDb2RlR3JhbnQ6IHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG5cblxuICAgIHRoaXMuYXBpID0gdGhpcy5jcmVhdGVBUEkocm91dGVzKTtcblxuICAgIHRoaXMuYXV0aG9yaXplciA9IG5ldyBDZm5BdXRob3JpemVyKHRoaXMsICdjZm5BdXRoJywge1xuICAgICAgcmVzdEFwaUlkOiB0aGlzLmFwaS5yZXN0QXBpSWQsXG4gICAgICBuYW1lOiAnSW5zdGFudFNpdGVBUElBdXRob3JpemVyJyxcbiAgICAgIHR5cGU6ICdDT0dOSVRPX1VTRVJfUE9PTFMnLFxuICAgICAgaWRlbnRpdHlTb3VyY2U6ICdtZXRob2QucmVxdWVzdC5oZWFkZXIuQXV0aG9yaXphdGlvbicsXG4gICAgICBwcm92aWRlckFybnM6IFt1c2VyUG9vbC51c2VyUG9vbEFybl0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmNyZWF0ZVJlc291cmNlcyh0aGlzLmFwaS5yb290LCByb3V0ZXMpO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJhcGlCYXNlXCIsIHtcbiAgICAgIHZhbHVlOiB0aGlzLmFwaS51cmxcbiAgICB9KTtcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwidXNlclBvb2xJZFwiLCB7XG4gICAgICB2YWx1ZTogdXNlclBvb2wudXNlclBvb2xJZFxuICAgIH0pXG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcInVzZXJQb29sQ2xpZW50SWRcIiwge1xuICAgICAgdmFsdWU6IHVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWRcbiAgICB9KTtcbiAgICBcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcInVzZXJQb29sUmVnaW9uXCIsIHtcbiAgICAgIHZhbHVlOiBlbnZpcm9ubWVudC5SRUdJT05cbiAgICB9KTtcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwiczNCdWNrZXRcIiwge1xuICAgICAgdmFsdWU6IHRoaXMuczNidWNrZXQuYnVja2V0TmFtZVxuICAgIH0pO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJjZkRpc3RyaWJ1dGlvbkRvbWFpbk5hbWVcIiwge1xuICAgICAgdmFsdWU6IHRoaXMuY2xvdWRmcm9udC5kaXN0cmlidXRpb25Eb21haW5OYW1lXG4gICAgfSk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcImNmRGlzdHJpYnV0aW9uSWRcIiwge1xuICAgICAgdmFsdWU6IHRoaXMuY2xvdWRmcm9udC5kaXN0cmlidXRpb25JZFxuICAgIH0pO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJ3ZWJVaVVzZXJcIiwge1xuICAgICAgdmFsdWU6IGVudmlyb25tZW50LldFQlVJX1VTRVJcbiAgICB9KTtcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwid2ViVWlQYXNzXCIsIHtcbiAgICAgIHZhbHVlOiBlbnZpcm9ubWVudC5XRUJVSV9QQVNTXG4gICAgfSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVzb3VyY2VzKHJlc291cmNlOiBJUmVzb3VyY2UsIG9iajogb2JqZWN0KTogSVJlc291cmNlIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XG4gICAgICB2ZXJicy5pbmNsdWRlcyhrZXkudG9VcHBlckNhc2UoKSlcbiAgICAgICAgICA/IHJlc291cmNlLmFkZE1ldGhvZChrZXksIFxuICAgICAgICAgICAgICBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbih0aGlzLmNyZWF0ZUxhbWJkYShrZXkudG9VcHBlckNhc2UoKSx2YWx1ZSkpLCBcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBBdXRob3JpemF0aW9uVHlwZS5DT0dOSVRPLFxuICAgICAgICAgICAgICAgIGF1dGhvcml6ZXI6IHtcbiAgICAgICAgICAgICAgICAgIGF1dGhvcml6ZXJJZDogdGhpcy5hdXRob3JpemVyLnJlZlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIDogdGhpcy5jcmVhdGVSZXNvdXJjZXMocmVzb3VyY2UuYWRkUmVzb3VyY2Uoa2V5KSwgdmFsdWUpO1xuICAgIH1cblxuICAgIHJldHVybiByZXNvdXJjZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQVBJKHJvdXRlczogb2JqZWN0KTogTGFtYmRhUmVzdEFwaSB7XG4gICAgY29uc3QgYXBpID0gbmV3IGFwaUdhdGV3YXkuTGFtYmRhUmVzdEFwaSh0aGlzLCAnZHVkYScsIHtcbiAgICAgIGhhbmRsZXI6IHRoaXMuY3JlYXRlTGFtYmRhKCdBTlknLCdyb290JyksXG4gICAgICBwcm94eTogZmFsc2UsXG4gICAgICBkZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnM6IHRoaXMuZ2V0Q09SUyh0aGlzLmNsb3VkZnJvbnQuZGlzdHJpYnV0aW9uRG9tYWluTmFtZSlcbiAgICB9KTtcbiAgICBcbiAgICBcbiAgICBhcGkucm9vdC5hZGRNZXRob2QoJ0FOWScpO1xuICAgIHJldHVybiBhcGk7XG4gIH1cblxuICBwcml2YXRlIGdldENPUlMoZG9tYWluOiBzdHJpbmcpOiBDb3JzT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93T3JpZ2luczogW1wiKlwiXSwgLy8gc2FmZSB0byBwYXNzIHRva2VuaXplZCBjbG91ZGZyb250IGRvbWFpbiBpbiB0aGlzIGxpc3QgXG4gICAgICBhbGxvd01ldGhvZHM6IFtcIk9QVElPTlNcIixcIkdFVFwiLFwiUFVUXCIsXCJQT1NUXCIsXCJERUxFVEVcIixcIlBBVENIXCJdLFxuICAgICAgYWxsb3dIZWFkZXJzOiBbXCJDb250ZW50LVR5cGVcIixcbiAgICAgICAgICAgICAgICAgICAgIFwiWC1BbXotRGF0ZVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJBdXRob3JpemF0aW9uXCIsXG4gICAgICAgICAgICAgICAgICAgICBcIlgtQXBpLUtleVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1TZWN1cml0eS1Ub2tlblwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1Vc2VyLUFnZW50XCJdLFxuICAgICAgYWxsb3dDcmVkZW50aWFsczogZmFsc2VcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxhbWJkYSh2ZXJiOiBzdHJpbmcsIGRpcjogc3RyaW5nKTogRnVuY3Rpb24ge1xuICAgIHJldHVybiBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIGAke3ZlcmJ9LSR7ZGlyfS1MYW1iZGFgLCB0aGlzLmdldExhbWJkYUNvbmZpZyhgbGFtYmRhcy8ke2Rpcn1gKSk7XG4gIH1cblxuICBwcml2YXRlIGdldExhbWJkYUNvbmZpZyhwYXRoOiBzdHJpbmcpOiBGdW5jdGlvblByb3BzIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGgpLFxuICAgICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICBlbnZpcm9ubWVudCxcbiAgICAgIGxheWVyczogW3RoaXMubGF5ZXJdXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMYXllcigpOiBMYXllclZlcnNpb24ge1xuICAgIHJldHVybiBuZXcgbGFtYmRhLkxheWVyVmVyc2lvbih0aGlzLCAnbGFtYmRhLWxheWVyJywge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KCdsYXllcnMnKSxcbiAgICAgIGNvbXBhdGlibGVSdW50aW1lczogW2xhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YXSxcbiAgICAgIH0pO1xuICB9XG59XG4iXX0=