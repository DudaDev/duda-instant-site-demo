"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DudaInstantSiteStack = void 0;
const cdk = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const s3 = require("@aws-cdk/aws-s3");
const cf = require("@aws-cdk/aws-cloudfront");
const apiGateway = require("@aws-cdk/aws-apigateway");
const dotenv = require("dotenv");
const aws_apigateway_1 = require("@aws-cdk/aws-apigateway");
const routes_1 = require("./routes");
const pjson = require("../package.json");
const aws_cognito_1 = require("@aws-cdk/aws-cognito");
dotenv.config();
const verbs = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'];
const environment = (({ API_USER = '', API_PASS = '', API_BASE = '', WEBUI_USER = '', WEBUI_PASS = '', REGION = '' }) => ({
    API_USER,
    API_PASS,
    API_BASE,
    WEBUI_USER,
    WEBUI_PASS,
    REGION,
    VERSION: pjson.version,
    NODE_PATH: '/opt/nodejs/lib/:/opt/nodejs/node_modules:$LAMBDA_RUNTIME_DIR/node_modules'
}))(process.env);
class DudaInstantSiteStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.layer = this.createLayer();
        // S3 frontend bucket
        this.s3bucket = new s3.Bucket(this, "DudaInstantSiteFrontend", {
            publicReadAccess: true,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            websiteIndexDocument: "index.html"
        });
        // Cloudfront
        this.cloudfront = new cf.CloudFrontWebDistribution(this, "CDKCRAStaticDistribution", {
            originConfigs: [
                {
                    s3OriginSource: {
                        s3BucketSource: this.s3bucket
                    },
                    behaviors: [{ isDefaultBehavior: true }]
                },
            ]
        });
        const userPool = new aws_cognito_1.UserPool(this, 'Instant Sites User Pool', {
            signInAliases: {
                username: true
            },
            selfSignUpEnabled: false
        });
        const userPoolClient = userPool.addClient('Instant Sites User Pool Client', {
            authFlows: {
                userSrp: true
            },
            oAuth: {
                callbackUrls: ['http://localhost:3000'],
                logoutUrls: ['http://localhost:3000'],
                flows: {
                    implicitCodeGrant: true
                }
            }
        });
        this.api = this.createAPI(routes_1.default);
        this.authorizer = new aws_apigateway_1.CfnAuthorizer(this, 'cfnAuth', {
            restApiId: this.api.restApiId,
            name: 'InstantSiteAPIAuthorizer',
            type: 'COGNITO_USER_POOLS',
            identitySource: 'method.request.header.Authorization',
            providerArns: [userPool.userPoolArn],
        });
        this.createResources(this.api.root, routes_1.default);
        new cdk.CfnOutput(this, "apiBase", {
            value: this.api.url
        });
        new cdk.CfnOutput(this, "userPoolId", {
            value: userPool.userPoolId
        });
        new cdk.CfnOutput(this, "userPoolClientId", {
            value: userPoolClient.userPoolClientId
        });
        new cdk.CfnOutput(this, "userPoolRegion", {
            value: environment.REGION
        });
        new cdk.CfnOutput(this, "s3Bucket", {
            value: this.s3bucket.bucketDomainName
        });
        new cdk.CfnOutput(this, "cfDeploymentDomain", {
            value: this.cloudfront.distributionDomainName
        });
        new cdk.CfnOutput(this, "webUiUser", {
            value: environment.WEBUI_USER
        });
        new cdk.CfnOutput(this, "webUiPass", {
            value: environment.WEBUI_PASS
        });
    }
    createResources(resource, obj) {
        for (const [key, value] of Object.entries(obj)) {
            verbs.includes(key.toUpperCase())
                ? resource.addMethod(key, new apiGateway.LambdaIntegration(this.createLambda(key.toUpperCase(), value)), {
                    authorizationType: aws_apigateway_1.AuthorizationType.COGNITO,
                    authorizer: {
                        authorizerId: this.authorizer.ref
                    }
                })
                : this.createResources(resource.addResource(key), value);
        }
        return resource;
    }
    createAPI(routes) {
        const api = new apiGateway.LambdaRestApi(this, 'duda', {
            handler: this.createLambda('ANY', 'root'),
            proxy: false,
            defaultCorsPreflightOptions: this.getCORS(this.cloudfront.distributionDomainName)
        });
        api.root.addMethod('ANY');
        return api;
    }
    getCORS(domain) {
        return {
            allowOrigins: ["*"],
            allowMethods: ["OPTIONS", "GET", "PUT", "POST", "DELETE", "PATCH"],
            allowHeaders: ["Content-Type",
                "X-Amz-Date",
                "Authorization",
                "X-Api-Key",
                "X-Amz-Security-Token",
                "X-Amz-User-Agent"],
            allowCredentials: false
        };
    }
    createLambda(verb, dir) {
        return new lambda.Function(this, `${verb}-${dir}-Lambda`, this.getLambdaConfig(`lambdas/${dir}`));
    }
    getLambdaConfig(path) {
        return {
            code: lambda.Code.fromAsset(path),
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
            timeout: cdk.Duration.seconds(20),
            environment,
            layers: [this.layer]
        };
    }
    createLayer() {
        return new lambda.LayerVersion(this, 'lambda-layer', {
            code: lambda.Code.fromAsset('layers'),
            compatibleRuntimes: [lambda.Runtime.NODEJS_14_X],
        });
    }
}
exports.DudaInstantSiteStack = DudaInstantSiteStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVkYS1pbnN0YW50LXNpdGUtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkdWRhLWluc3RhbnQtc2l0ZS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBcUM7QUFDckMsOENBQThDO0FBQzlDLHNDQUFzQztBQUN0Qyw4Q0FBOEM7QUFDOUMsc0RBQXNEO0FBQ3RELGlDQUFpQztBQUVqQyw0REFBa0g7QUFDbEgscUNBQThCO0FBQzlCLHlDQUF5QztBQUN6QyxzREFBZ0Q7QUFFaEQsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRWhCLE1BQU0sS0FBSyxHQUFHLENBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUMsT0FBTyxFQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BELE1BQU0sV0FBVyxHQUFHLENBQ2xCLENBQUMsRUFBRSxRQUFRLEdBQUcsRUFBRSxFQUFFLFFBQVEsR0FBRyxFQUFFLEVBQUUsUUFBUSxHQUFHLEVBQUUsRUFBRSxVQUFVLEdBQUcsRUFBRSxFQUFFLFVBQVUsR0FBRyxFQUFFLEVBQUUsTUFBTSxHQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLFFBQVE7SUFDUixRQUFRO0lBQ1IsUUFBUTtJQUNSLFVBQVU7SUFDVixVQUFVO0lBQ1YsTUFBTTtJQUNOLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztJQUN0QixTQUFTLEVBQUUsNEVBQTRFO0NBQzFGLENBQUMsQ0FDSCxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUVmLE1BQWEsb0JBQXFCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFRakQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVoQyxxQkFBcUI7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TUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO1lBQ25ELElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7WUFDckMsa0JBQWtCLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztTQUMvQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0Y7QUFwS0Qsb0RBb0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgczMgZnJvbSAnQGF3cy1jZGsvYXdzLXMzJztcbmltcG9ydCAqIGFzIGNmIGZyb20gJ0Bhd3MtY2RrL2F3cy1jbG91ZGZyb250JztcbmltcG9ydCAqIGFzIGFwaUdhdGV3YXkgZnJvbSAnQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXknO1xuaW1wb3J0ICogYXMgZG90ZW52IGZyb20gJ2RvdGVudic7XG5pbXBvcnQgeyBGdW5jdGlvbiwgRnVuY3Rpb25Qcm9wcywgTGF5ZXJWZXJzaW9uIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBDb3JzT3B0aW9ucywgSVJlc291cmNlLCBMYW1iZGFSZXN0QXBpLCBDZm5BdXRob3JpemVyLCBBdXRob3JpemF0aW9uVHlwZSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCByb3V0ZXMgZnJvbSAnLi9yb3V0ZXMnO1xuaW1wb3J0ICogYXMgcGpzb24gZnJvbSAnLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7IFVzZXJQb29sIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWNvZ25pdG8nO1xuXG5kb3RlbnYuY29uZmlnKCk7XG5cbmNvbnN0IHZlcmJzID0gWydHRVQnLCdQT1NUJywnUFVUJywnUEFUQ0gnLCdERUxFVEUnXTtcbmNvbnN0IGVudmlyb25tZW50ID0gKFxuICAoeyBBUElfVVNFUiA9ICcnLCBBUElfUEFTUyA9ICcnLCBBUElfQkFTRSA9ICcnLCBXRUJVSV9VU0VSID0gJycsIFdFQlVJX1BBU1MgPSAnJywgUkVHSU9OPScnIH0pID0+ICh7XG4gICAgICBBUElfVVNFUixcbiAgICAgIEFQSV9QQVNTLFxuICAgICAgQVBJX0JBU0UsXG4gICAgICBXRUJVSV9VU0VSLFxuICAgICAgV0VCVUlfUEFTUyxcbiAgICAgIFJFR0lPTixcbiAgICAgIFZFUlNJT046IHBqc29uLnZlcnNpb24sXG4gICAgICBOT0RFX1BBVEg6ICcvb3B0L25vZGVqcy9saWIvOi9vcHQvbm9kZWpzL25vZGVfbW9kdWxlczokTEFNQkRBX1JVTlRJTUVfRElSL25vZGVfbW9kdWxlcydcbiAgfSlcbikocHJvY2Vzcy5lbnYpO1xuXG5leHBvcnQgY2xhc3MgRHVkYUluc3RhbnRTaXRlU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuXG4gIHByaXZhdGUgbGF5ZXI6IExheWVyVmVyc2lvbjtcbiAgcHJpdmF0ZSBzM2J1Y2tldDogczMuQnVja2V0O1xuICBwcml2YXRlIGNsb3VkZnJvbnQ6IGNmLkNsb3VkRnJvbnRXZWJEaXN0cmlidXRpb247XG4gIHByaXZhdGUgYXBpOiBMYW1iZGFSZXN0QXBpO1xuICBwcml2YXRlIGF1dGhvcml6ZXI6IENmbkF1dGhvcml6ZXI7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMubGF5ZXIgPSB0aGlzLmNyZWF0ZUxheWVyKCk7XG5cbiAgICAvLyBTMyBmcm9udGVuZCBidWNrZXRcbiAgICB0aGlzLnMzYnVja2V0ID0gbmV3IHMzLkJ1Y2tldCh0aGlzLCBcIkR1ZGFJbnN0YW50U2l0ZUZyb250ZW5kXCIsIHtcbiAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IHRydWUsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgd2Vic2l0ZUluZGV4RG9jdW1lbnQ6IFwiaW5kZXguaHRtbFwiXG4gICAgfSk7XG5cbiAgICAvLyBDbG91ZGZyb250XG4gICAgdGhpcy5jbG91ZGZyb250ID0gbmV3IGNmLkNsb3VkRnJvbnRXZWJEaXN0cmlidXRpb24odGhpcywgXCJDREtDUkFTdGF0aWNEaXN0cmlidXRpb25cIiwge1xuICAgICAgb3JpZ2luQ29uZmlnczogW1xuICAgICAgICB7XG4gICAgICAgICAgczNPcmlnaW5Tb3VyY2U6IHtcbiAgICAgICAgICAgIHMzQnVja2V0U291cmNlOiB0aGlzLnMzYnVja2V0XG4gICAgICAgICAgfSxcbiAgICAgICAgICBiZWhhdmlvcnM6IFt7aXNEZWZhdWx0QmVoYXZpb3I6IHRydWV9XVxuICAgICAgICB9LFxuICAgICAgXVxuICAgIH0pO1xuXG4gICAgY29uc3QgdXNlclBvb2wgPSBuZXcgVXNlclBvb2wodGhpcywgJ0luc3RhbnQgU2l0ZXMgVXNlciBQb29sJywge1xuICAgICAgc2lnbkluQWxpYXNlczoge1xuICAgICAgICB1c2VybmFtZTogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHNlbGZTaWduVXBFbmFibGVkOiBmYWxzZVxuICAgIH0pO1xuXG4gICAgY29uc3QgdXNlclBvb2xDbGllbnQgPSB1c2VyUG9vbC5hZGRDbGllbnQoJ0luc3RhbnQgU2l0ZXMgVXNlciBQb29sIENsaWVudCcsIHtcbiAgICAgIGF1dGhGbG93czoge1xuICAgICAgICB1c2VyU3JwOiB0cnVlXG4gICAgICB9LFxuICAgICAgb0F1dGg6IHtcbiAgICAgICAgY2FsbGJhY2tVcmxzOiBbJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCddLFxuICAgICAgICBsb2dvdXRVcmxzOiBbJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCddLFxuICAgICAgICBmbG93czoge1xuICAgICAgICAgIGltcGxpY2l0Q29kZUdyYW50OiB0cnVlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuXG5cbiAgICB0aGlzLmFwaSA9IHRoaXMuY3JlYXRlQVBJKHJvdXRlcyk7XG5cbiAgICB0aGlzLmF1dGhvcml6ZXIgPSBuZXcgQ2ZuQXV0aG9yaXplcih0aGlzLCAnY2ZuQXV0aCcsIHtcbiAgICAgIHJlc3RBcGlJZDogdGhpcy5hcGkucmVzdEFwaUlkLFxuICAgICAgbmFtZTogJ0luc3RhbnRTaXRlQVBJQXV0aG9yaXplcicsXG4gICAgICB0eXBlOiAnQ09HTklUT19VU0VSX1BPT0xTJyxcbiAgICAgIGlkZW50aXR5U291cmNlOiAnbWV0aG9kLnJlcXVlc3QuaGVhZGVyLkF1dGhvcml6YXRpb24nLFxuICAgICAgcHJvdmlkZXJBcm5zOiBbdXNlclBvb2wudXNlclBvb2xBcm5dLFxuICAgIH0pO1xuXG4gICAgdGhpcy5jcmVhdGVSZXNvdXJjZXModGhpcy5hcGkucm9vdCwgcm91dGVzKTtcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwiYXBpQmFzZVwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5hcGkudXJsXG4gICAgfSk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcInVzZXJQb29sSWRcIiwge1xuICAgICAgdmFsdWU6IHVzZXJQb29sLnVzZXJQb29sSWRcbiAgICB9KVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJ1c2VyUG9vbENsaWVudElkXCIsIHtcbiAgICAgIHZhbHVlOiB1c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkXG4gICAgfSk7XG4gICAgXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJ1c2VyUG9vbFJlZ2lvblwiLCB7XG4gICAgICB2YWx1ZTogZW52aXJvbm1lbnQuUkVHSU9OXG4gICAgfSk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcInMzQnVja2V0XCIsIHtcbiAgICAgIHZhbHVlOiB0aGlzLnMzYnVja2V0LmJ1Y2tldERvbWFpbk5hbWVcbiAgICB9KTtcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwiY2ZEZXBsb3ltZW50RG9tYWluXCIsIHtcbiAgICAgIHZhbHVlOiB0aGlzLmNsb3VkZnJvbnQuZGlzdHJpYnV0aW9uRG9tYWluTmFtZVxuICAgIH0pO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJ3ZWJVaVVzZXJcIiwge1xuICAgICAgdmFsdWU6IGVudmlyb25tZW50LldFQlVJX1VTRVJcbiAgICB9KTtcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwid2ViVWlQYXNzXCIsIHtcbiAgICAgIHZhbHVlOiBlbnZpcm9ubWVudC5XRUJVSV9QQVNTXG4gICAgfSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVzb3VyY2VzKHJlc291cmNlOiBJUmVzb3VyY2UsIG9iajogb2JqZWN0KTogSVJlc291cmNlIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XG4gICAgICB2ZXJicy5pbmNsdWRlcyhrZXkudG9VcHBlckNhc2UoKSlcbiAgICAgICAgICA/IHJlc291cmNlLmFkZE1ldGhvZChrZXksIFxuICAgICAgICAgICAgICBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbih0aGlzLmNyZWF0ZUxhbWJkYShrZXkudG9VcHBlckNhc2UoKSx2YWx1ZSkpLCBcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBBdXRob3JpemF0aW9uVHlwZS5DT0dOSVRPLFxuICAgICAgICAgICAgICAgIGF1dGhvcml6ZXI6IHtcbiAgICAgICAgICAgICAgICAgIGF1dGhvcml6ZXJJZDogdGhpcy5hdXRob3JpemVyLnJlZlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIDogdGhpcy5jcmVhdGVSZXNvdXJjZXMocmVzb3VyY2UuYWRkUmVzb3VyY2Uoa2V5KSwgdmFsdWUpO1xuICAgIH1cblxuICAgIHJldHVybiByZXNvdXJjZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQVBJKHJvdXRlczogb2JqZWN0KTogTGFtYmRhUmVzdEFwaSB7XG4gICAgY29uc3QgYXBpID0gbmV3IGFwaUdhdGV3YXkuTGFtYmRhUmVzdEFwaSh0aGlzLCAnZHVkYScsIHtcbiAgICAgIGhhbmRsZXI6IHRoaXMuY3JlYXRlTGFtYmRhKCdBTlknLCdyb290JyksXG4gICAgICBwcm94eTogZmFsc2UsXG4gICAgICBkZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnM6IHRoaXMuZ2V0Q09SUyh0aGlzLmNsb3VkZnJvbnQuZGlzdHJpYnV0aW9uRG9tYWluTmFtZSlcbiAgICB9KTtcbiAgICBcbiAgICBcbiAgICBhcGkucm9vdC5hZGRNZXRob2QoJ0FOWScpO1xuICAgIHJldHVybiBhcGk7XG4gIH1cblxuICBwcml2YXRlIGdldENPUlMoZG9tYWluOiBzdHJpbmcpOiBDb3JzT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93T3JpZ2luczogW1wiKlwiXSwgLy8gc2FmZSB0byBwYXNzIHRva2VuaXplZCBjbG91ZGZyb250IGRvbWFpbiBpbiB0aGlzIGxpc3QgXG4gICAgICBhbGxvd01ldGhvZHM6IFtcIk9QVElPTlNcIixcIkdFVFwiLFwiUFVUXCIsXCJQT1NUXCIsXCJERUxFVEVcIixcIlBBVENIXCJdLFxuICAgICAgYWxsb3dIZWFkZXJzOiBbXCJDb250ZW50LVR5cGVcIixcbiAgICAgICAgICAgICAgICAgICAgIFwiWC1BbXotRGF0ZVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJBdXRob3JpemF0aW9uXCIsXG4gICAgICAgICAgICAgICAgICAgICBcIlgtQXBpLUtleVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1TZWN1cml0eS1Ub2tlblwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1Vc2VyLUFnZW50XCJdLFxuICAgICAgYWxsb3dDcmVkZW50aWFsczogZmFsc2VcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxhbWJkYSh2ZXJiOiBzdHJpbmcsIGRpcjogc3RyaW5nKTogRnVuY3Rpb24ge1xuICAgIHJldHVybiBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIGAke3ZlcmJ9LSR7ZGlyfS1MYW1iZGFgLCB0aGlzLmdldExhbWJkYUNvbmZpZyhgbGFtYmRhcy8ke2Rpcn1gKSk7XG4gIH1cblxuICBwcml2YXRlIGdldExhbWJkYUNvbmZpZyhwYXRoOiBzdHJpbmcpOiBGdW5jdGlvblByb3BzIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGgpLFxuICAgICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICBlbnZpcm9ubWVudCxcbiAgICAgIGxheWVyczogW3RoaXMubGF5ZXJdXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMYXllcigpOiBMYXllclZlcnNpb24ge1xuICAgIHJldHVybiBuZXcgbGFtYmRhLkxheWVyVmVyc2lvbih0aGlzLCAnbGFtYmRhLWxheWVyJywge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KCdsYXllcnMnKSxcbiAgICAgIGNvbXBhdGlibGVSdW50aW1lczogW2xhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YXSxcbiAgICAgIH0pO1xuICB9XG59XG4iXX0=