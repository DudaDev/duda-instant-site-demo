"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DudaInstantSiteStack = void 0;
const cdk = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const apiGateway = require("@aws-cdk/aws-apigateway");
const dotenv = require("dotenv");
const cdk_spa_deploy_1 = require("cdk-spa-deploy");
const routes_1 = require("./routes");
const pjson = require("../package.json");
dotenv.config();
const verbs = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'];
const environment = (({ API_USER = '', API_PASS = '', API_BASE = '' }) => ({
    API_USER,
    API_PASS,
    API_BASE,
    VERSION: pjson.version,
    NODE_PATH: '/opt/nodejs/lib/:/opt/nodejs/node_modules:$LAMBDA_RUNTIME_DIR/node_modules'
}))(process.env);
class DudaInstantSiteStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.layer = this.createLayer();
        this.frontend = new cdk_spa_deploy_1.SPADeploy(this, 'cfDeploy')
            .createSiteWithCloudfront({
            indexDoc: 'index.html',
            websiteFolder: '../frontend/build'
        });
        this.createAPI(routes_1.default);
        // fs.writeFileSync('../frontend/.env',`API_BASE=${this.api.url}`);
    }
    createResources(resource, obj) {
        for (const [key, value] of Object.entries(obj)) {
            verbs.includes(key.toUpperCase())
                ? resource.addMethod(key, new apiGateway.LambdaIntegration(this.createLambda(key.toUpperCase(), value)))
                : this.createResources(resource.addResource(key), value);
        }
        return resource;
    }
    createAPI(routes) {
        this.api = new apiGateway.LambdaRestApi(this, 'duda', {
            handler: this.createLambda('ANY', 'root'),
            proxy: false,
            defaultCorsPreflightOptions: this.getCORS(this.frontend.distribution.distributionDomainName)
        });
        this.api.root.addMethod('ANY');
        this.createResources(this.api.root, routes);
        return this.api;
    }
    getCORS(domain) {
        return {
            allowOrigins: ["*"],
            allowMethods: ["OPTIONS", "GET", "PUT", "POST", "DELETE", "PATCH"],
            allowHeaders: ["Content-Type",
                "X-Amz-Date",
                "Authorization",
                "X-Api-Key",
                "X-Amz-Security-Token",
                "X-Amz-User-Agent"],
            allowCredentials: false
        };
    }
    createLambda(verb, dir) {
        return new lambda.Function(this, `${verb}-${dir}-Lambda`, this.getLambdaConfig(`lambdas/${dir}`));
    }
    getLambdaConfig(path) {
        return {
            code: lambda.Code.fromAsset(path),
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
            timeout: cdk.Duration.seconds(20),
            environment,
            layers: [this.layer]
        };
    }
    createLayer() {
        return new lambda.LayerVersion(this, 'lambda-layer', {
            code: lambda.Code.fromAsset('layers'),
            compatibleRuntimes: [lambda.Runtime.NODEJS_14_X],
        });
    }
}
exports.DudaInstantSiteStack = DudaInstantSiteStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVkYS1pbnN0YW50LXNpdGUtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkdWRhLWluc3RhbnQtc2l0ZS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBcUM7QUFDckMsOENBQThDO0FBQzlDLHNEQUFxRDtBQUNyRCxpQ0FBaUM7QUFHakMsbURBQXVGO0FBQ3ZGLHFDQUE4QjtBQUU5Qix5Q0FBeUM7QUFJekMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRWhCLE1BQU0sS0FBSyxHQUFHLENBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUMsT0FBTyxFQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BELE1BQU0sV0FBVyxHQUFHLENBQ2xCLENBQUMsRUFBRSxRQUFRLEdBQUcsRUFBRSxFQUFFLFFBQVEsR0FBRyxFQUFFLEVBQUUsUUFBUSxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELFFBQVE7SUFDUixRQUFRO0lBQ1IsUUFBUTtJQUNSLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztJQUN0QixTQUFTLEVBQUUsNEVBQTRFO0NBQzFGLENBQUMsQ0FDSCxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUVmLE1BQWEsb0JBQXFCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFNakQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVoQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksMEJBQVMsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDO2FBQzVDLHdCQUF3QixDQUFDO1lBQ3hCLFFBQVEsRUFBRSxZQUFZO1lBQ3RCLGFBQWEsRUFBRSxtQkFBbUI7U0FDbkMsQ0FBQyxDQUFDO1FB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T0FBTyxDQUFDLFdBQVcsQ0FBQztTQUMvQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0Y7QUEvRUQsb0RBK0VDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgYXBpR2F0ZXdheSBmcm9tICdAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheSdcbmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHsgRnVuY3Rpb24sIEZ1bmN0aW9uUHJvcHMsIExheWVyVmVyc2lvbiB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQ29yc09wdGlvbnMsIElSZXNvdXJjZSwgTGFtYmRhUmVzdEFwaSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCB7IFNQQURlcGxveSwgU1BBRGVwbG95bWVudCwgU1BBRGVwbG95bWVudFdpdGhDbG91ZEZyb250IH0gZnJvbSAnY2RrLXNwYS1kZXBsb3knO1xuaW1wb3J0IHJvdXRlcyBmcm9tICcuL3JvdXRlcyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwanNvbiBmcm9tICcuLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHsgaXNGdW5jdGlvbk9yQ29uc3RydWN0b3JUeXBlTm9kZSwgdG9rZW5Ub1N0cmluZyB9IGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IHsgc2V0RmxhZ3NGcm9tU3RyaW5nIH0gZnJvbSAndjgnO1xuXG5kb3RlbnYuY29uZmlnKCk7XG5cbmNvbnN0IHZlcmJzID0gWydHRVQnLCdQT1NUJywnUFVUJywnUEFUQ0gnLCdERUxFVEUnXTtcbmNvbnN0IGVudmlyb25tZW50ID0gKFxuICAoeyBBUElfVVNFUiA9ICcnLCBBUElfUEFTUyA9ICcnLCBBUElfQkFTRSA9ICcnIH0pID0+ICh7XG4gICAgICBBUElfVVNFUixcbiAgICAgIEFQSV9QQVNTLFxuICAgICAgQVBJX0JBU0UsXG4gICAgICBWRVJTSU9OOiBwanNvbi52ZXJzaW9uLFxuICAgICAgTk9ERV9QQVRIOiAnL29wdC9ub2RlanMvbGliLzovb3B0L25vZGVqcy9ub2RlX21vZHVsZXM6JExBTUJEQV9SVU5USU1FX0RJUi9ub2RlX21vZHVsZXMnXG4gIH0pXG4pKHByb2Nlc3MuZW52KTtcblxuZXhwb3J0IGNsYXNzIER1ZGFJbnN0YW50U2l0ZVN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcblxuICBwcml2YXRlIGxheWVyOiBMYXllclZlcnNpb247XG4gIHByaXZhdGUgZnJvbnRlbmQ6IFNQQURlcGxveW1lbnRXaXRoQ2xvdWRGcm9udDtcbiAgcHJpdmF0ZSBhcGk6IExhbWJkYVJlc3RBcGk7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMubGF5ZXIgPSB0aGlzLmNyZWF0ZUxheWVyKCk7XG5cbiAgICB0aGlzLmZyb250ZW5kID0gbmV3IFNQQURlcGxveSh0aGlzLCAnY2ZEZXBsb3knKVxuICAgICAgLmNyZWF0ZVNpdGVXaXRoQ2xvdWRmcm9udCh7XG4gICAgICAgIGluZGV4RG9jOiAnaW5kZXguaHRtbCcsXG4gICAgICAgIHdlYnNpdGVGb2xkZXI6ICcuLi9mcm9udGVuZC9idWlsZCdcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5jcmVhdGVBUEkocm91dGVzKTtcblxuICAgIC8vIGZzLndyaXRlRmlsZVN5bmMoJy4uL2Zyb250ZW5kLy5lbnYnLGBBUElfQkFTRT0ke3RoaXMuYXBpLnVybH1gKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVzb3VyY2VzKHJlc291cmNlOiBJUmVzb3VyY2UsIG9iajogb2JqZWN0KTogSVJlc291cmNlIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XG4gICAgICB2ZXJicy5pbmNsdWRlcyhrZXkudG9VcHBlckNhc2UoKSlcbiAgICAgICAgICA/IHJlc291cmNlLmFkZE1ldGhvZChrZXksIG5ldyBhcGlHYXRld2F5LkxhbWJkYUludGVncmF0aW9uKHRoaXMuY3JlYXRlTGFtYmRhKGtleS50b1VwcGVyQ2FzZSgpLHZhbHVlKSkpXG4gICAgICAgICAgOiB0aGlzLmNyZWF0ZVJlc291cmNlcyhyZXNvdXJjZS5hZGRSZXNvdXJjZShrZXkpLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVBUEkocm91dGVzOiBvYmplY3QpOiBMYW1iZGFSZXN0QXBpIHtcbiAgICB0aGlzLmFwaSA9IG5ldyBhcGlHYXRld2F5LkxhbWJkYVJlc3RBcGkodGhpcywgJ2R1ZGEnLCB7XG4gICAgICBoYW5kbGVyOiB0aGlzLmNyZWF0ZUxhbWJkYSgnQU5ZJywncm9vdCcpLFxuICAgICAgcHJveHk6IGZhbHNlLFxuICAgICAgZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zOiB0aGlzLmdldENPUlModGhpcy5mcm9udGVuZC5kaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uRG9tYWluTmFtZSlcbiAgICB9KTtcbiAgICBcbiAgICB0aGlzLmFwaS5yb290LmFkZE1ldGhvZCgnQU5ZJyk7XG4gICAgdGhpcy5jcmVhdGVSZXNvdXJjZXModGhpcy5hcGkucm9vdCwgcm91dGVzKTtcbiAgICByZXR1cm4gdGhpcy5hcGk7XG4gIH1cblxuICBwcml2YXRlIGdldENPUlMoZG9tYWluOiBzdHJpbmcpOiBDb3JzT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93T3JpZ2luczogW1wiKlwiXSxcbiAgICAgIGFsbG93TWV0aG9kczogW1wiT1BUSU9OU1wiLFwiR0VUXCIsXCJQVVRcIixcIlBPU1RcIixcIkRFTEVURVwiLFwiUEFUQ0hcIl0sXG4gICAgICBhbGxvd0hlYWRlcnM6IFtcIkNvbnRlbnQtVHlwZVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1EYXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICBcIkF1dGhvcml6YXRpb25cIixcbiAgICAgICAgICAgICAgICAgICAgIFwiWC1BcGktS2V5XCIsXG4gICAgICAgICAgICAgICAgICAgICBcIlgtQW16LVNlY3VyaXR5LVRva2VuXCIsXG4gICAgICAgICAgICAgICAgICAgICBcIlgtQW16LVVzZXItQWdlbnRcIl0sXG4gICAgICBhbGxvd0NyZWRlbnRpYWxzOiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTGFtYmRhKHZlcmI6IHN0cmluZywgZGlyOiBzdHJpbmcpOiBGdW5jdGlvbiB7XG4gICAgcmV0dXJuIG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgYCR7dmVyYn0tJHtkaXJ9LUxhbWJkYWAsIHRoaXMuZ2V0TGFtYmRhQ29uZmlnKGBsYW1iZGFzLyR7ZGlyfWApKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TGFtYmRhQ29uZmlnKHBhdGg6IHN0cmluZyk6IEZ1bmN0aW9uUHJvcHMge1xuICAgIHJldHVybiB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aCksXG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDIwKSxcbiAgICAgIGVudmlyb25tZW50LFxuICAgICAgbGF5ZXJzOiBbdGhpcy5sYXllcl1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxheWVyKCk6IExheWVyVmVyc2lvbiB7XG4gICAgcmV0dXJuIG5ldyBsYW1iZGEuTGF5ZXJWZXJzaW9uKHRoaXMsICdsYW1iZGEtbGF5ZXInLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoJ2xheWVycycpLFxuICAgICAgY29tcGF0aWJsZVJ1bnRpbWVzOiBbbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1hdLFxuICAgICAgfSk7XG4gIH1cbn1cbiJdfQ==