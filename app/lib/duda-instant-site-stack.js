"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DudaInstantSiteStack = void 0;
const cdk = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const apiGateway = require("@aws-cdk/aws-apigateway");
const dotenv = require("dotenv");
const aws_apigateway_1 = require("@aws-cdk/aws-apigateway");
const cdk_spa_deploy_1 = require("cdk-spa-deploy");
const routes_1 = require("./routes");
const pjson = require("../package.json");
const aws_cognito_1 = require("@aws-cdk/aws-cognito");
dotenv.config();
const verbs = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'];
const environment = (({ API_USER = '', API_PASS = '', API_BASE = '' }) => ({
    API_USER,
    API_PASS,
    API_BASE,
    VERSION: pjson.version,
    NODE_PATH: '/opt/nodejs/lib/:/opt/nodejs/node_modules:$LAMBDA_RUNTIME_DIR/node_modules'
}))(process.env);
class DudaInstantSiteStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.layer = this.createLayer();
        this.frontend = new cdk_spa_deploy_1.SPADeploy(this, 'cfDeploy')
            .createSiteWithCloudfront({
            indexDoc: 'index.html',
            websiteFolder: '../frontend/build'
        });
        const userPool = new aws_cognito_1.UserPool(this, 'Instant Sites User Pool', {
            signInAliases: {
                username: true
            },
            selfSignUpEnabled: false
        });
        this.api = this.createAPI(routes_1.default);
        this.authorizer = new aws_apigateway_1.CfnAuthorizer(this, 'cfnAuth', {
            restApiId: this.api.restApiId,
            name: 'InstantSiteAPIAuthorizer',
            type: 'COGNITO_USER_POOLS',
            identitySource: 'method.request.header.Authorization',
            providerArns: [userPool.userPoolArn],
        });
        this.createResources(this.api.root, routes_1.default);
        // fs.writeFileSync('../frontend/.env',`API_BASE=${this.api.url}`);
    }
    createResources(resource, obj) {
        for (const [key, value] of Object.entries(obj)) {
            verbs.includes(key.toUpperCase())
                ? resource.addMethod(key, new apiGateway.LambdaIntegration(this.createLambda(key.toUpperCase(), value)), {
                    authorizationType: aws_apigateway_1.AuthorizationType.COGNITO,
                    authorizer: {
                        authorizerId: this.authorizer.ref
                    }
                })
                : this.createResources(resource.addResource(key), value);
        }
        return resource;
    }
    createAPI(routes) {
        const api = new apiGateway.LambdaRestApi(this, 'duda', {
            handler: this.createLambda('ANY', 'root'),
            proxy: false,
            defaultCorsPreflightOptions: this.getCORS(this.frontend.distribution.distributionDomainName)
        });
        api.root.addMethod('ANY');
        return api;
    }
    getCORS(domain) {
        return {
            allowOrigins: ["*"],
            allowMethods: ["OPTIONS", "GET", "PUT", "POST", "DELETE", "PATCH"],
            allowHeaders: ["Content-Type",
                "X-Amz-Date",
                "Authorization",
                "X-Api-Key",
                "X-Amz-Security-Token",
                "X-Amz-User-Agent"],
            allowCredentials: false
        };
    }
    createLambda(verb, dir) {
        return new lambda.Function(this, `${verb}-${dir}-Lambda`, this.getLambdaConfig(`lambdas/${dir}`));
    }
    getLambdaConfig(path) {
        return {
            code: lambda.Code.fromAsset(path),
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
            timeout: cdk.Duration.seconds(20),
            environment,
            layers: [this.layer]
        };
    }
    createLayer() {
        return new lambda.LayerVersion(this, 'lambda-layer', {
            code: lambda.Code.fromAsset('layers'),
            compatibleRuntimes: [lambda.Runtime.NODEJS_14_X],
        });
    }
}
exports.DudaInstantSiteStack = DudaInstantSiteStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVkYS1pbnN0YW50LXNpdGUtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkdWRhLWluc3RhbnQtc2l0ZS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBcUM7QUFDckMsOENBQThDO0FBQzlDLHNEQUFxRDtBQUNyRCxpQ0FBaUM7QUFFakMsNERBQWtIO0FBQ2xILG1EQUF1RjtBQUN2RixxQ0FBOEI7QUFFOUIseUNBQXlDO0FBQ3pDLHNEQUFnRDtBQUloRCxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFaEIsTUFBTSxLQUFLLEdBQUcsQ0FBQyxLQUFLLEVBQUMsTUFBTSxFQUFDLEtBQUssRUFBQyxPQUFPLEVBQUMsUUFBUSxDQUFDLENBQUM7QUFDcEQsTUFBTSxXQUFXLEdBQUcsQ0FDbEIsQ0FBQyxFQUFFLFFBQVEsR0FBRyxFQUFFLEVBQUUsUUFBUSxHQUFHLEVBQUUsRUFBRSxRQUFRLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEQsUUFBUTtJQUNSLFFBQVE7SUFDUixRQUFRO0lBQ1IsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO0lBQ3RCLFNBQVMsRUFBRSw0RUFBNEU7Q0FDMUYsQ0FBQyxDQUNILENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBRWYsTUFBYSxvQkFBcUIsU0FBUSxHQUFHLENBQUMsS0FBSztJQU9qRCxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQXNCO1FBQ2xFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWhDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSwwQkFBUyxDQUFDLElBQUksRUFBRSxVQUFVLENBQUM7YUFDNUMsd0JBQXdCLENBQUM7WUFDeEIsUUFBUSxFQUFFLFlBQVk7WUFDdEIsYUFBYSxFQUFF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UyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDcEcsQ0FBQztJQUVPLGVBQWUsQ0FBQyxJQUFZO1FBQ2xDLE9BQU87WUFDTCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQ2pDLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxXQUFXO1lBQ1gsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUNyQixDQUFBO0lBQ0gsQ0FBQztJQUVPLFdBQVc7UUFDakIsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtZQUNuRCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1lBQ3JDLGtCQUFrQixFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7U0FDL0MsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNGO0FBeEdELG9EQXdHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGFwaUdhdGV3YXkgZnJvbSAnQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXknXG5pbXBvcnQgKiBhcyBkb3RlbnYgZnJvbSAnZG90ZW52JztcbmltcG9ydCB7IEZ1bmN0aW9uLCBGdW5jdGlvblByb3BzLCBMYXllclZlcnNpb24gfSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCB7IENvcnNPcHRpb25zLCBJUmVzb3VyY2UsIExhbWJkYVJlc3RBcGksIENmbkF1dGhvcml6ZXIsIEF1dGhvcml6YXRpb25UeXBlIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXknO1xuaW1wb3J0IHsgU1BBRGVwbG95LCBTUEFEZXBsb3ltZW50LCBTUEFEZXBsb3ltZW50V2l0aENsb3VkRnJvbnQgfSBmcm9tICdjZGstc3BhLWRlcGxveSc7XG5pbXBvcnQgcm91dGVzIGZyb20gJy4vcm91dGVzJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBqc29uIGZyb20gJy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQgeyBVc2VyUG9vbCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1jb2duaXRvJztcbmltcG9ydCB7IGlzRnVuY3Rpb25PckNvbnN0cnVjdG9yVHlwZU5vZGUsIHRva2VuVG9TdHJpbmcgfSBmcm9tICd0eXBlc2NyaXB0JztcbmltcG9ydCB7IHNldEZsYWdzRnJvbVN0cmluZyB9IGZyb20gJ3Y4JztcblxuZG90ZW52LmNvbmZpZygpO1xuXG5jb25zdCB2ZXJicyA9IFsnR0VUJywnUE9TVCcsJ1BVVCcsJ1BBVENIJywnREVMRVRFJ107XG5jb25zdCBlbnZpcm9ubWVudCA9IChcbiAgKHsgQVBJX1VTRVIgPSAnJywgQVBJX1BBU1MgPSAnJywgQVBJX0JBU0UgPSAnJyB9KSA9PiAoe1xuICAgICAgQVBJX1VTRVIsXG4gICAgICBBUElfUEFTUyxcbiAgICAgIEFQSV9CQVNFLFxuICAgICAgVkVSU0lPTjogcGpzb24udmVyc2lvbixcbiAgICAgIE5PREVfUEFUSDogJy9vcHQvbm9kZWpzL2xpYi86L29wdC9ub2RlanMvbm9kZV9tb2R1bGVzOiRMQU1CREFfUlVOVElNRV9ESVIvbm9kZV9tb2R1bGVzJ1xuICB9KVxuKShwcm9jZXNzLmVudik7XG5cbmV4cG9ydCBjbGFzcyBEdWRhSW5zdGFudFNpdGVTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG5cbiAgcHJpdmF0ZSBsYXllcjogTGF5ZXJWZXJzaW9uO1xuICBwcml2YXRlIGZyb250ZW5kOiBTUEFEZXBsb3ltZW50V2l0aENsb3VkRnJvbnQ7XG4gIHByaXZhdGUgYXBpOiBMYW1iZGFSZXN0QXBpO1xuICBwcml2YXRlIGF1dGhvcml6ZXI6IENmbkF1dGhvcml6ZXI7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMubGF5ZXIgPSB0aGlzLmNyZWF0ZUxheWVyKCk7XG5cbiAgICB0aGlzLmZyb250ZW5kID0gbmV3IFNQQURlcGxveSh0aGlzLCAnY2ZEZXBsb3knKVxuICAgICAgLmNyZWF0ZVNpdGVXaXRoQ2xvdWRmcm9udCh7XG4gICAgICAgIGluZGV4RG9jOiAnaW5kZXguaHRtbCcsXG4gICAgICAgIHdlYnNpdGVGb2xkZXI6ICcuLi9mcm9udGVuZC9idWlsZCdcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgdXNlclBvb2wgPSBuZXcgVXNlclBvb2wodGhpcywgJ0luc3RhbnQgU2l0ZXMgVXNlciBQb29sJywge1xuICAgICAgc2lnbkluQWxpYXNlczoge1xuICAgICAgICB1c2VybmFtZTogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHNlbGZTaWduVXBFbmFibGVkOiBmYWxzZVxuICAgIH0pO1xuXG4gICAgdGhpcy5hcGkgPSB0aGlzLmNyZWF0ZUFQSShyb3V0ZXMpO1xuXG4gICAgdGhpcy5hdXRob3JpemVyID0gbmV3IENmbkF1dGhvcml6ZXIodGhpcywgJ2NmbkF1dGgnLCB7XG4gICAgICByZXN0QXBpSWQ6IHRoaXMuYXBpLnJlc3RBcGlJZCxcbiAgICAgIG5hbWU6ICdJbnN0YW50U2l0ZUFQSUF1dGhvcml6ZXInLFxuICAgICAgdHlwZTogJ0NPR05JVE9fVVNFUl9QT09MUycsXG4gICAgICBpZGVudGl0eVNvdXJjZTogJ21ldGhvZC5yZXF1ZXN0LmhlYWRlci5BdXRob3JpemF0aW9uJyxcbiAgICAgIHByb3ZpZGVyQXJuczogW3VzZXJQb29sLnVzZXJQb29sQXJuXSxcbiAgICB9KTtcblxuICAgIHRoaXMuY3JlYXRlUmVzb3VyY2VzKHRoaXMuYXBpLnJvb3QsIHJvdXRlcyk7XG4gICAgLy8gZnMud3JpdGVGaWxlU3luYygnLi4vZnJvbnRlbmQvLmVudicsYEFQSV9CQVNFPSR7dGhpcy5hcGkudXJsfWApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVSZXNvdXJjZXMocmVzb3VyY2U6IElSZXNvdXJjZSwgb2JqOiBvYmplY3QpOiBJUmVzb3VyY2Uge1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHtcbiAgICAgIHZlcmJzLmluY2x1ZGVzKGtleS50b1VwcGVyQ2FzZSgpKVxuICAgICAgICAgID8gcmVzb3VyY2UuYWRkTWV0aG9kKGtleSwgXG4gICAgICAgICAgICAgIG5ldyBhcGlHYXRld2F5LkxhbWJkYUludGVncmF0aW9uKHRoaXMuY3JlYXRlTGFtYmRhKGtleS50b1VwcGVyQ2FzZSgpLHZhbHVlKSksIFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgYXV0aG9yaXphdGlvblR5cGU6IEF1dGhvcml6YXRpb25UeXBlLkNPR05JVE8sXG4gICAgICAgICAgICAgICAgYXV0aG9yaXplcjoge1xuICAgICAgICAgICAgICAgICAgYXV0aG9yaXplcklkOiB0aGlzLmF1dGhvcml6ZXIucmVmXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgOiB0aGlzLmNyZWF0ZVJlc291cmNlcyhyZXNvdXJjZS5hZGRSZXNvdXJjZShrZXkpLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVBUEkocm91dGVzOiBvYmplY3QpOiBMYW1iZGFSZXN0QXBpIHtcbiAgICBjb25zdCBhcGkgPSBuZXcgYXBpR2F0ZXdheS5MYW1iZGFSZXN0QXBpKHRoaXMsICdkdWRhJywge1xuICAgICAgaGFuZGxlcjogdGhpcy5jcmVhdGVMYW1iZGEoJ0FOWScsJ3Jvb3QnKSxcbiAgICAgIHByb3h5OiBmYWxzZSxcbiAgICAgIGRlZmF1bHRDb3JzUHJlZmxpZ2h0T3B0aW9uczogdGhpcy5nZXRDT1JTKHRoaXMuZnJvbnRlbmQuZGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWUpXG4gICAgfSk7XG4gICAgXG4gICAgXG4gICAgYXBpLnJvb3QuYWRkTWV0aG9kKCdBTlknKTtcbiAgICByZXR1cm4gYXBpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDT1JTKGRvbWFpbjogc3RyaW5nKTogQ29yc09wdGlvbnMge1xuICAgIHJldHVybiB7XG4gICAgICBhbGxvd09yaWdpbnM6IFtcIipcIl0sXG4gICAgICBhbGxvd01ldGhvZHM6IFtcIk9QVElPTlNcIixcIkdFVFwiLFwiUFVUXCIsXCJQT1NUXCIsXCJERUxFVEVcIixcIlBBVENIXCJdLFxuICAgICAgYWxsb3dIZWFkZXJzOiBbXCJDb250ZW50LVR5cGVcIixcbiAgICAgICAgICAgICAgICAgICAgIFwiWC1BbXotRGF0ZVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJBdXRob3JpemF0aW9uXCIsXG4gICAgICAgICAgICAgICAgICAgICBcIlgtQXBpLUtleVwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1TZWN1cml0eS1Ub2tlblwiLFxuICAgICAgICAgICAgICAgICAgICAgXCJYLUFtei1Vc2VyLUFnZW50XCJdLFxuICAgICAgYWxsb3dDcmVkZW50aWFsczogZmFsc2VcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxhbWJkYSh2ZXJiOiBzdHJpbmcsIGRpcjogc3RyaW5nKTogRnVuY3Rpb24ge1xuICAgIHJldHVybiBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIGAke3ZlcmJ9LSR7ZGlyfS1MYW1iZGFgLCB0aGlzLmdldExhbWJkYUNvbmZpZyhgbGFtYmRhcy8ke2Rpcn1gKSk7XG4gIH1cblxuICBwcml2YXRlIGdldExhbWJkYUNvbmZpZyhwYXRoOiBzdHJpbmcpOiBGdW5jdGlvblByb3BzIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGgpLFxuICAgICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICBlbnZpcm9ubWVudCxcbiAgICAgIGxheWVyczogW3RoaXMubGF5ZXJdXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMYXllcigpOiBMYXllclZlcnNpb24ge1xuICAgIHJldHVybiBuZXcgbGFtYmRhLkxheWVyVmVyc2lvbih0aGlzLCAnbGFtYmRhLWxheWVyJywge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KCdsYXllcnMnKSxcbiAgICAgIGNvbXBhdGlibGVSdW50aW1lczogW2xhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YXSxcbiAgICAgIH0pO1xuICB9XG59XG4iXX0=